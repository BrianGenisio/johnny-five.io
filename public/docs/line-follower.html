<h1>Line Follower</h1>
<p>Run with:</p>
<pre><code class="language-bash">node src/j5/eg/line-follower.js
</code></pre>
<pre><code class="language-javascript">// This is an example of a line following robot.  It uses a
// Pololu QTR-8A reflectance array to read a line on my
// counter drawn with electrical tape.  You can see the 
// bot in action here: https://www.youtube.com/watch?v=i6n4CwqQer0

var fs = require(&quot;fs&quot;),
  five = require(&quot;johnny-five&quot;),
  ReflectArray = require(&quot;./reflect.array&quot;),
  board = new five.Board();

// Setup Standard input.  We use this to let the bot know that we&quot;ve finished
// calibrating
var stdin = process.stdin;
stdin.setRawMode(true);
stdin.resume();

var calibrationFile = &quot;.calibration&quot;;

// VERY simple driving rules.  It uses a mapping from the line value that comes
// from the Reflectance Array to the left and right wheel of the bot.
// This can be made much better, but it is a good start.
var drivingRules = {
  0: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.01
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.07
    }
  },

  1000: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.02
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.05
    }
  },

  2000: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.04
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.05
    }
  },

  2500: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.05
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.05
    }
  },

  3000: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.05
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.04
    }
  },

  4000: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.05
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.02
    }
  },

  5001: {
    left: {
      dir: &quot;cw&quot;,
      speed: 0.07
    },
    right: {
      dir: &quot;ccw&quot;,
      speed: 0.01
    }
  }
};

board.on(&quot;ready&quot;, function() {

  // Create an instance of the reflectance array.
  var eyes = new five.IR.Reflect.Array({
    emitter: 13,
    pins: [&quot;A0&quot;, &quot;A1&quot;, &quot;A2&quot;, &quot;A3&quot;, &quot;A4&quot;, &quot;A5&quot;],
    freq: 20
  });

  // These are the continuous servos that control the wheels
  var wheels = {
    left: new five.Servo({
      pin: 10,
      type: &quot;continuous&quot;
    }),
    right: new five.Servo({
      pin: 9,
      type: &quot;continuous&quot;
    })
  };

  // Make the eyes and wheels available in the REPL UI
  this.repl.inject({
    eyes: eyes,
    wheels: wheels
  });

  // When the bot starts up, enable the IR emitters and tell the wheels
  // to stop.  Calibrate the device.  When complete, drive.
  function init() {
    eyes.enable();
    wheels.left.stop();
    wheels.right.stop();

    calibrate(drive);
  }

  // Calibrate the bot.  If the calibration has been persisted, use it.
  // If not, calibrate the bot until the user presses a key.  Move the sensor
  // over light and dark regions several times.  Persist the calibration data
  // to a file so it doesn&quot;t need to do it again next time.
  function calibrate(whenComplete) {
    var savedCalibration, calibrating = true;

    if (fs.existsSync(calibrationFile)) {
      eyes.loadCalibration(JSON.parse(fs.readFileSync(calibrationFile)));
      whenComplete();
      return;
    }

    console.log(&quot;Calibrating.  Press a key...&quot;);

    eyes.calibrateUntil(function() {
      return !calibrating;
    });

    stdin.once(&quot;keypress&quot;, function() {
      calibrating = false;
      console.log(&quot;Done:&quot;, eyes.calibration);
      fs.writeFile(calibrationFile, JSON.stringify(eyes.calibration));
      whenComplete();
    });
  }

  // Drive the bot.  Every time a line value event comes in, figure out which
  // rule to follow from the rules mapping.  Tell the left and right wheels
  // which direction and how fast to spin.
  function drive() {
    eyes.on(&quot;line&quot;, function(err, line) {
      var rule;
      var threshold = Object.keys(drivingRules).find(function(r) {
        return line &lt;= parseInt(r);
      });

      if (!threshold) {
        console.log(&quot;Could not find threshold for &quot; + line);
      }

      rule = drivingRules[threshold];

      wheels.left[rule.left.dir](rule.left.speed);
      wheels.right[rule.right.dir](rule.right.speed);
    });
  }

  // Start the bot
  init();

});

</code></pre>
<h2>License</h2>
<p>Copyright (c) 2012-2013 Rick Waldron <a href="mailto:waldron.rick@gmail.com">waldron.rick@gmail.com</a>
Licensed under the MIT license.
Copyright (c) 2014 The Johnny-Five Contributors
Licensed under the MIT license.</p>
