<html>
<head>
  <meta charset="utf-8">
  <title>Johnny-Five</title>
  <meta name="description" content="Johnny-Five is an Open Source IoT and robotics programming framework">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="fonts" content="css/type.css">

  <script src="../js/fontloader.js" id="fontloader"></script>

  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <link href="favicon.ico" rel="icon">

</head>
<body>

  <div class="mast">
    <nav class="nav-primary wrapper icon-j5">

      <picture class="j5-icon">
        <source type="image/svg+xml" srcset="../img/js-logo.svg">
        <img src="../img/js-logo.png">
      </picture>

      <a href="/">Getting Started</a>
      <a href="/examples.html" class="current">Examples</a>
    </nav>

    <header role="banner" class="banner">
     <h1 class="site-hed">Examples</h1>
    </header>
  </div>

  <main class="central">
    <div class="wrap-a wrap-docs">

      <h1>Ed</h1>
<p>Run with:</p>
<pre><code class="language-bash">node eg/ed.js
</code></pre>
<pre><code class="language-javascript">var five = require(&quot;johnny-five&quot;),
  compulsive = require(&quot;compulsive&quot;);

var ED,
  priv = new WeakMap();


/**
 * ED
 *
 * Enforcement Droid Series
 *
 * http://www.lynxmotion.com/images/jpg/bratjr00.jpg
 * http://www.lynxmotion.com/images/html/build112.htm
 * Hardware:
  - 1 x Alum. Channel - 3&quot; Single Pack (ASB-503)
  - 2 x Multi-Purpose Servo Bracket Two Pack (ASB-04)
  - 1 x &quot;L&quot; Connector Bracket Two Pack (ASB-06)
  - 1 x &quot;C&quot; Servo Bracket w/ Ball Bearings Two Pack (ASB-09)
  - 1 x Robot Feet Pair (ARF-01)
  - 1 x SES Electronics Carrier (EC-02)
  - 1 x SSC-32 Servo Controller (SSC-32)
  - 4 x HS-422 (57oz.in.) Standard Servo (S422)
 *
 * @param {Object} opts Optional properties object
 */

function ED(opts) {

  opts = opts || {};

  // Standard servos center at 90Â°
  this.center = opts.center || 90;

  // Initiale movement is forward
  this.direction = &quot;fwd&quot;;

  // Accessor for reading the current servo position will
  // be defined and assigned to this.degrees object.
  this.degrees = {};

  // holds a reference to the current repeating/looping sequence
  this.sequence = null;

  // Table of times (avg) to complete tasks
  this.times = {
    step: 0,
    attn: 0
  };

  // Minor normalization of incoming properties
  opts.right = opts.right || {};
  opts.left = opts.left || {};

  // Initialize the right and left cooperative servos
  // TODO: Support pre-initialized servo instances
  this.servos = {
    right: {
      hip: opts.right.hip &amp;&amp; new five.Servo(opts.right.hip),
      foot: opts.right.foot &amp;&amp; new five.Servo(opts.right.foot)
    },
    left: {
      hip: opts.left.hip &amp;&amp; new five.Servo(opts.left.hip),
      foot: opts.left.foot &amp;&amp; new five.Servo(opts.left.foot)
    }
  };

  // Create shortcut properties
  this.right = this.servos.right;
  this.left = this.servos.left;

  // Create accessor descriptors:
  //
  //  .left { .foot, .hip }
  //  .right { .foot, .hip }
  //
  [&quot;right&quot;, &quot;left&quot;].forEach(function(key) {

    var descriptor = {};

    [&quot;foot&quot;, &quot;hip&quot;].forEach(function(part) {
      descriptor[part] = {
        get: function() {
          var history = this.servos[key][part].history,
            last = history[history.length - 1];

          return last &amp;&amp; last.degrees || 90;
        }.bind(this)
      };
    }, this);

    this.degrees[key] = {};

    // And finally, create properties with the generated descriptor
    Object.defineProperties(this.degrees[key], descriptor);
  }, this);


  Object.defineProperty(this, &quot;isCentered&quot;, {
    get: function() {
      var right, left;

      right = this.degrees.right;
      left = this.degrees.left;

      if ((right.foot === 90 &amp;&amp; right.hip === 90) &amp;&amp;
        (left.foot === 90 &amp;&amp; left.foot === 90)) {
        return true;
      }
      return false;
    }
  });

  // Store a recallable history of movement
  // TODO: Include in savable history
  this.history = [{
    timestamp: Date.now(),
    side: &quot;right&quot;,
    right: {
      hip: 0,
      foot: 0
    },
    left: {
      hip: 0,
      foot: 0
    }
  }];

  // Create an entry in the private data store.
  priv.set(this, {
    // `isWalking` is used in:
    //    ED.prototype.(attn|stop)
    //    ED.prototype.(forward|fwd;reverse|rev)
    isWalking: false,

    // Allowed to hit the dance floor.
    canDance: true
  });
}

/**
 * attn Stop and stand still
 * @return {Object} this
 */
//ED.prototype.attn = ED.prototype.stop = function() {
ED.prototype.attn = function(options) {
  options = options || {};

  if (!options.isWalking) {

    if (this.sequence) {
      this.sequence.stop();
      this.sequence = null;
    }

    priv.set(this, {
      isWalking: false
    });
  }

  this.move({
    type: &quot;attn&quot;,
    right: {
      hip: 90,
      foot: 90
    },
    left: {
      hip: 90,
      foot: 90
    }
  });
};

/**
 * step Take a step
 *
 * @param {String} instruct Give the step function a specific instruction,
 *                          one of: (fwd, rev, left, right)
 *
 */
ED.prototype.step = function(direct) {
  var isLeft, isFwd, opposing, direction, state;

  state = priv.get(this);

  if (/fwd|rev/.test(direct)) {
    direction = direct;
    direct = undefined;
  } else {
    direction = &quot;fwd&quot;;
  }

  // Derive which side to step on; based on last step or explicit step
  this.side = direct || (this.side !== &quot;right&quot; ? &quot;right&quot; : &quot;left&quot;);

  // Update the value of the current direction
  this.direction = direction;

  // Determine if the bot is moving fwd
  // Used in phase 3 to conditionally control the servo degrees
  isFwd = this.direction === &quot;fwd&quot;;

  // Determine if this is the left foot
  // Used in phase 3 to conditionally control the servo degrees
  isLeft = this.side === &quot;left&quot;;

  // Opposing leg side, used in prestep and phase 2;
  // opposing = isLeft ? &quot;right&quot; : &quot;left&quot;;

  // Begin stepping movements.
  //
  this.queue([

    // Phase 1
    {
      wait: 500,
      task: function() {
        var stepping, opposing, instruct;

        stepping = isLeft ? &quot;left&quot; : &quot;right&quot;;
        opposing = isLeft ? &quot;right&quot; : &quot;left&quot;;

        instruct = {};

        // Lift the currently stepping foot, while
        // leaning on the currently opposing foot.
        instruct[stepping] = {
          foot: isLeft ? 40 : 140
        };
        instruct[opposing] = {
          foot: isLeft ? 70 : 110
        };

        // Swing currently stepping hips
        this.move(instruct);
      }.bind(this)
    },

    // Phase 2
    {
      wait: 500,
      task: function() {
        var degrees = isLeft ?
          (isFwd ? 120 : 60) :
          (isFwd ? 60 : 120);

        // Swing currently stepping hips
        this.move({
          type: &quot;swing&quot;,
          right: {
            hip: degrees
          },
          left: {
            hip: degrees
          }
        });

      }.bind(this)
    },

    // Phase 3
    {
      wait: 500,
      task: function() {

        // Flatten feet to surface
        this.servos.right.foot.center();
        this.servos.left.foot.center();



      }.bind(this)
    }
  ]);
};

[
  /**
   * forward, fwd
   *
   * Move the bot forward
   */
  {
    name: &quot;forward&quot;,
    abbr: &quot;fwd&quot;
  },

  /**
   * reverse, rev
   *
   * Move the bot in reverse
   */
  {
    name: &quot;reverse&quot;,
    abbr: &quot;rev&quot;
  }

].forEach(function(dir) {

  ED.prototype[dir.name] = ED.prototype[dir.abbr] = function() {
    var startAt, stepper, state;

    startAt = 10;
    state = priv.get(this);

    // If ED is already walking in this direction, return immediately;
    // This prevents multiple movement loops from being scheduled.
    if (this.direction === dir.abbr &amp;&amp; state.isWalking) {
      return;
    }

    // If a sequence reference exists, kill it. This will
    // clear all pending queue repeaters.
    if (this.sequence) {
      this.sequence.stop();
      this.sequence = null;
    }


    this.direction = dir.abbr;

    // Update the private state to indicate
    // that the bot is currently walking.
    //
    // This is used by the behaviour loop to
    // conditionally continue walking or to terminate.
    //
    // Walk termination occurs in the ED.prototype.attn method
    //
    priv.set(this, {
      isWalking: true
    });

    stepper = function(loop) {
      // Capture of sequence queue reference
      if (this.sequence === null) {
        this.sequence = loop;
      }

      this.step(dir.abbr);

      if (!priv.get(this).isWalking) {
        loop.stop();
      }
    }.bind(this);

    // If the bot is not centered, ie. all servos at 90degrees,
    // bring the bot to attention before proceeding.
    if (!this.isCentered) {
      this.attn({
        isWalking: true
      });
      // Offset the amount ms required for attn() to complete
      startAt = 750;
    }

    this.queue([{
      wait: startAt,
      task: function() {
        this.step(dir.abbr);
      }.bind(this)
    }, {
      loop: 1500,
      task: stepper
    }]);
  };
});

ED.prototype.dance = function() {
  var isLeft, restore, state;

  // Derive which side to step on; based on last step or explicit step
  this.side = this.side !== &quot;right&quot; ? &quot;right&quot; : &quot;left&quot;;

  // Determine if this is the left foot
  // Used in phase 3 to conditionally control the servo degrees
  isLeft = this.side === &quot;left&quot;;

  this.attn();

  if (typeof this.moves === &quot;undefined&quot;) {
    this.moves = 0;
  }

  this.queue([
    // Phase 1
    {
      wait: 500,
      task: function() {
        var degrees = isLeft ? 120 : 60;

        if (this.moves % 2 === 0) {
          this.move({
            type: &quot;attn&quot;,
            right: {
              hip: 90,
              foot: 60
            },
            left: {
              hip: 90,
              foot: 120
            }
          });
        } else {

          this.move({
            type: &quot;attn&quot;,
            right: {
              hip: 90,
              foot: 120
            },
            left: {
              hip: 90,
              foot: 60
            }
          });
        }

        // Swing currently stepping hips
        this.move({
          type: &quot;swing&quot;,
          right: {
            hip: degrees
          },
          left: {
            hip: degrees
          }
        });

        // restore = this.servos[ this.side ].foot.last.degrees;
        // this.servos[ this.side ].foot.move( restore === 140 ? 120 : 60 );

      }.bind(this)
    },

    // Phase 2
    {
      wait: 500,
      task: function() {
        var degrees = isLeft ? 60 : 120;

        // Swing currently stepping hips
        this.move({
          type: &quot;swing&quot;,
          right: {
            hip: degrees
          },
          left: {
            hip: degrees
          }
        });

        // this.servos[ this.side ].foot.move( restore );

      }.bind(this)
    },

    // Phase 3
    {
      wait: 500,
      task: function() {

        this.move({
          type: &quot;attn&quot;,
          right: {
            hip: 90,
            foot: 90
          },
          left: {
            hip: 90,
            foot: 90
          }
        });

        this.dance();

      }.bind(this)
    }
  ]);

  this.moves++;
};


/**
 * move Move the bot in an arbitrary direction
 * @param  {Object} positions left/right hip/foot positions
 *
 */
ED.prototype.move = function(positions) {
  var start, type;

  if (this.history.length) {
    start = this.history[this.history.length - 1];
  }

  type = positions.type || &quot;step&quot;;

  [&quot;foot&quot;, &quot;hip&quot;].forEach(function(section) {
    [&quot;right&quot;, &quot;left&quot;].forEach(function(side) {
      var interval, endAt, startAt, servo, step, s;

      if (typeof positions[side] === &quot;undefined&quot;) {
        return;
      }

      endAt = positions[side][section];
      servo = this.servos[side][section];
      startAt = this.degrees[side][section];

      // Degrees per step
      step = 2;

      s = Date.now();

      if (!endAt || endAt === startAt) {
        return;
      }

      if (start) {
        // Determine degree step direction
        if (endAt &lt; startAt) {
          step *= -1;
        }

        // Repeat each step for required number of steps to move
        // servo into new position. Each step is ~20ms duration
        this.repeat(Math.abs(endAt - startAt) / 2, 10, function() {
          // console.log( startAt );
          servo.move(startAt += step);

          if (startAt === endAt) {
            this.times[type] = (this.times[type] + (Date.now() - s)) / 2;
          }
        }.bind(this));

      } else {
        // TODO: Stop doing this
        servo.move(endAt);
        five.Fn.sleep(500);
      }
    }, this);
  }, this);

  // Push a record object into the stepping history
  this.history.push({
    timestamp: Date.now(),
    side: this.side,
    right: five.Fn.extend({
      hip: 0,
      foot: 0
    }, this.degrees.right, positions.right),
    left: five.Fn.extend({
      hip: 0,
      foot: 0
    }, this.degrees.left, positions.left)
  });
};

// Borrow API from Compulsive
[&quot;wait&quot;, &quot;loop&quot;, &quot;queue&quot;, &quot;repeat&quot;].forEach(function(api) {
  ED.prototype[api] = compulsive[api];
});

// Begin program when the board, serial and
// firmata are connected and ready
(new five.Board()).on(&quot;ready&quot;, function() {
  var biped;

  // Create new Enforcement Droid
  // assign servos
  biped = new ED({
    right: {
      hip: 9,
      foot: 11
    },
    left: {
      hip: 10,
      foot: 12
    }
  });

  // Inject into REPL for manual controls
  this.repl.inject({
    s: new five.Servo.Array(),
    b: biped
  });

  biped.attn();

  biped.wait(1000, function() {
    biped.fwd();
  });

  // Controlled via REPL:
  // b.fwd(), b.rev(), b.attn()
});



// http://www.lynxmotion.com/images/html/build112.htm

</code></pre>
<h2>Breadboard/Illustration</h2>
<p><img src="breadboard/ed.png" alt="../img/breadboard/ed.png"></p>
<h2>License</h2>
<p>Copyright (c) 2012, 2013, 2014 Rick Waldron <a href="mailto:waldron.rick@gmail.com">waldron.rick@gmail.com</a>
Licensed under the MIT license.
Copyright (c) 2014, 2015 The Johnny-Five Contributors
Licensed under the MIT license.</p>


    </div>
  </main>

<script src="js/main.js"></script>
<script src="js/programs.json"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
