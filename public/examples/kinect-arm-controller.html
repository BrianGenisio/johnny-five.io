<html>
<head>
  <meta charset="utf-8">
  <title>Johnny-Five</title>
  <meta name="description" content="Johnny-Five is an Open Source IoT and robotics programming framework">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="fonts" content="css/type.css">

  <script src="../js/fontloader.js" id="fontloader"></script>

  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <link href="favicon.ico" rel="icon">

</head>
<body>

  <div class="mast">
    <nav class="nav-primary wrapper icon-j5">

      <picture class="j5-icon">
        <source type="image/svg+xml" srcset="../img/js-logo.svg">
        <img src="../img/js-logo.png">
      </picture>

      <a href="/">Getting Started</a>
      <a href="/examples.html" class="current">Examples</a>
    </nav>

    <header role="banner" class="banner">
     <h1 class="site-hed">Examples</h1>
    </header>
  </div>

  <main class="central">
    <div class="wrap-a wrap-docs">

      <h1>Kinect Arm Controller</h1>
<p>Run with:</p>
<pre><code class="language-bash">node eg/kinect-arm-controller.js
</code></pre>
<pre><code class="language-javascript">&quot;use strict&quot;;

var five, PVector, OpenNI;

five = require(&quot;johnny-five&quot;);
/**
 * Note:
 *
 * PVector is a slightly-ported version of
 * Processing's PVector.
 *
 */
PVector = require(&quot;./pvector&quot;).PVector;
/**
 * Note:
 *
 * To run this program you must first install
 * libusb and OpenNI... Good luck with that.
 *
 * Two sets of instructions are available:
 * - https://github.com/OpenNI/OpenNI
 * - https://code.google.com/p/simple-openni/wiki/Installation
 *
 * Then:
 *
 * npm install oppeni
 *
 * Learn more about node-openni here:
 * - https://github.com/pgte/node-openni
 *
 */
OpenNI = require(&quot;openni&quot;);

/**
 * Joint
 *
 * Construct Joint objects.
 *
 * @param {Object} initializer { [x, [y, [z]]] }
 */

function Joint(initializer) {
  /**
   * joint {
   *   x, y, z
   * }
   */
  five.Fn.assign(
    this, Joint.DEFAULTS, initializer || {}
  );
}

Object.freeze(
  Joint.DEFAULTS = {
    x: 0,
    y: 0,
    z: 0
  }
);

/**
 * Skeleton
 *
 * Initialize a &quot;collection&quot; of Joint objects
 * as a cohesive data type
 *
 * @param {Object} initializer { joints = {} }
 */

function Skeleton(initializer) {
  /**
   * skeleton {
   *   joints, kinect
   * }
   */
  five.Fn.assign(
    this, Skeleton.DEFAULTS, initializer || {}
  );

  // Initialize each declared Joint in Skeleton.Joints
  Skeleton.Joints.forEach(function(joint) {
    this.joints[joint] = new Joint();
  }, this);
}

Object.freeze(
  Skeleton.DEFAULTS = {
    inFrame: false,
    joints: {}
  }
);

Skeleton.Joints = [
  &quot;head&quot;,
  &quot;neck&quot;,

  &quot;torso&quot;,
  &quot;waist&quot;,

  &quot;left_shoulder&quot;,
  &quot;left_elbow&quot;,
  &quot;left_hand&quot;,

  &quot;right_shoulder&quot;,
  &quot;right_elbow&quot;,
  &quot;right_hand&quot;,

  &quot;left_hip&quot;,
  &quot;left_knee&quot;,
  &quot;left_foot&quot;,

  &quot;right_hip&quot;,
  &quot;right_knee&quot;,
  &quot;right_foot&quot;
];

Skeleton.Events = [
  &quot;newuser&quot;,
  &quot;lostuser&quot;,
  &quot;posedetected&quot;,
  &quot;calibrationstart&quot;,
  &quot;calibrationsuccess&quot;,
  &quot;calibrationfail&quot;
];

var Skeletons = [];


/**
 * Change
 *
 * Produces change &quot;tracking&quot; instances
 * to determine if a given value has changed
 * drastically enough
 */

function Change(margin) {
  this.last = 0;
  this.margin = margin || 0;
}

/**
 * isNoticeable
 *
 * Determine if a given value has changed
 * enough to be considered &quot;noticeable&quot;.
 *
 * @param  {Number} value  [description]
 * @param  {Number} margin Optionally override the
 *                         change instance's margin
 *
 * @return {Boolean} returns true if value is different
 *                           enough from the last value
 *                           to be considered &quot;noticeable&quot;
 */
Change.prototype.isNoticeable = function(value, margin) {
  margin = margin || this.margin;

  if (!Number.isFinite(value)) {
    return false;
  }

  if ((value &gt; this.last + margin) || (value &lt; this.last - margin)) {
    this.last = value;
    return true;
  }
  return false;
};

/**
 * scale
 *
 * Scaling that provides rounding on
 * the scaled result value.
 *
 * @return {Number}
 */

function scale() {
  return Math.round(
    five.Fn.scale.apply(null, arguments)
  );
}

/**
 * angleOf
 *
 * Produce the angle of 2 vectors on a given axis.
 *
 * @param  {PVector} vec1
 * @param  {PVector} vec2
 * @param  {PVector} axis
 *
 * @return {Number} Radians converted to degrees
 */

function angleOf(vec1, vec2, axis) {
  return PVector.degrees(
    PVector.between(
      PVector.sub(vec2, vec1), axis
    )
  );
}

five.Board().on(&quot;ready&quot;, function() {
  var status, defs, servos, kinect;

  status = {
    true: &quot;IN FRAME&quot;,
    false: &quot;OUT OF FRAME&quot;
  };

  // http://www.ranchbots.com/robot_arm/images/arm_diagram.jpg
  defs = [
    // &quot;Pivot/Rotator&quot;
    {
      id: &quot;rotator&quot;,
      pin: 6,
      range: [0, 180],
      startAt: 90
    },
    // &quot;Shoulder&quot;
    {
      id: &quot;upper&quot;,
      pin: 9,
      range: [0, 180],
      startAt: 180
    },
    // &quot;Elbow&quot;
    {
      id: &quot;fore&quot;,
      pin: 10,
      range: [90, 180],
      startAt: 90
    },
    // &quot;Wrist&quot;
    {
      id: &quot;wrist&quot;,
      pin: 11,
      range: [10, 170],
      startAt: 60
    },
    // &quot;Grip&quot;
    {
      id: &quot;claw&quot;,
      pin: 12,
      range: [10, 170],
      startAt: 0
    }
  ];

  // Remove the last two, we're not using them yet.
  defs = defs.slice(0, -2);

  // Reduce the defs array into a plain object
  // of stored servo instances, where the servo
  // id is the property name.
  servos = defs.reduce(function(initialized, def) {
    return (initialized[def.id] = five.Servo(def), initialized);
  }, {});

  // Initialize the OpenNI/Kinect
  kinect = new OpenNI();

  // For each declared Skeleton.Joints, bind
  // an event handler to the joint event by name.
  Skeleton.Joints.forEach(function(joint) {
    // When joint data is received, update the
    // associated Skeleton's joints array
    // with data for the given joint.
    kinect.on(joint, function(id, x, y, z) {
      var skeleton, vector;

      skeleton = Skeletons[id];

      if (skeleton) {

        vector = skeleton.joints[joint];

        if (vector) {
          vector.x = x;
          vector.y = y;
          vector.z = z;
        }
      }
    });
  });

  Skeleton.Events.forEach(function(type) {
    kinect.on(type, function(id) {
      var isPresence, skeleton;

      // Limit the number of skeletons to one.
      if (id !== 1) {
        return;
      }

      console.log(&quot;%s (%d)&quot;, type, id);

      isPresence = [&quot;newuser&quot;, &quot;lostuser&quot;].some(function(val) {
        return val === type;
      });

      if (isPresence) {
        skeleton = Skeletons[id];

        if (!skeleton) {
          skeleton = Skeletons[id] = new Skeleton();
        }

        skeleton.inFrame = type === &quot;newuser&quot; ?
          true : false;

        console.log(status[skeleton.inFrame]);
      }
    });
  });


  var last = Date.now();
  var interval = 1000 / 30;
  var rlow = 0;
  var rhigh = 0;
  var change = {
    upper: new Change(2),
    fore: new Change(2),
    rotator: new Change(2)
  };

  void (function main() {
    setImmediate(main);

    var values, angles, now, joints, right,
      orientation, upper, fore, rotator, axis;

    now = Date.now();

    if (now &lt; last + interval) {
      return;
    }

    last = now;

    values = {
      upper: 0,
      fore: 0,
      rotator: 0
    };

    angles = {
      upper: 0,
      fore: 0
    };

    if (Skeletons.length &amp;&amp; (joints = Skeletons[1].joints)) {
      upper = joints.right_shoulder;
      fore = joints.right_elbow;
      rotator = joints.right_hand;
      axis = joints.right_hip;

      if (upper &amp;&amp; fore &amp;&amp; rotator &amp;&amp; axis) {

        right = {
          upper: new PVector(upper.x, upper.y),
          fore: new PVector(fore.x, fore.y),
          rotator: new PVector(rotator.x, rotator.y),
          axis: new PVector(axis.x, axis.y)
        };

        orientation = {
          torso: PVector.sub(right.upper, right.axis),
          arm: PVector.sub(right.fore, right.upper)
        };

        if (rlow === 0 || rlow &gt; rotator.z) {
          rlow = Math.round(rotator.z);
        }

        if (rhigh === 0 || rhigh &lt; rotator.z) {
          rhigh = Math.round(rotator.z);
        }

        angles.upper = Math.round(
          angleOf(right.fore, right.upper, orientation.torso)
        );

        angles.fore = Math.round(
          angleOf(right.rotator, right.fore, orientation.arm)
        );

        values.upper = scale(angles.upper, 0, 180, 180, 0);
        values.fore = scale(angles.fore, 180, 0, 90, 180);

        // When the elbow/hand are higher then the shoulder,
        // flip the scaled rotator value.
        values.rotator = values.upper &lt; 110 &amp;&amp; values.fore &gt; 110 ?
          scale(rotator.z, rlow, rhigh, 180, 0) :
          scale(rotator.z, rlow, rhigh, 0, 180);

        // Once all of the Kinect joint vectors have been
        // calculated and scaled to a value in degrees,
        // do a final check to ensure that a move is worth
        // making and if so, set the servo position
        //
        if (change.rotator.isNoticeable(values.rotator)) {
          servos.rotator.to(values.rotator);
        }

        if (change.upper.isNoticeable(values.upper)) {
          servos.upper.to(values.upper);
        }

        if (change.fore.isNoticeable(values.fore)) {
          servos.fore.to(values.fore);
        }
      }
    }
  })();


  // References
  // http://www.ranchbots.com/robot_arm/images/arm_diagram.jpg
  // https://github.com/OpenNI/OpenNI/blob/master/Include/XnCppWrapper.h
  // http://www.mrtmrcn.com/en/post/2011/11/08/Kinect-Part-5-Kinect-Skeleton-Tracking.aspx
  // http://code.google.com/p/bikinect/source/browse/trunk/MappInect/Skeleton.pde
  // https://github.com/Sensebloom/OSCeleton-examples/blob/master/processing/Stickmanetic/Stickmanetic.pde
  // http://www.pcl-users.org/openni-device-h-47-26-fatal-error-XnCppWrapper-h-No-such-file-or-directory-td3174297.html
  // http://kinectcar.ronsper.com/docs/openni/_xn_cpp_wrapper_8h_source.html

});

</code></pre>
<h2>License</h2>
<p>Copyright (c) 2012, 2013, 2014 Rick Waldron <a href="mailto:waldron.rick@gmail.com">waldron.rick@gmail.com</a>
Licensed under the MIT license.
Copyright (c) 2014, 2015 The Johnny-Five Contributors
Licensed under the MIT license.</p>


    </div>
  </main>

<script src="js/main.js"></script>
<script src="js/programs.json"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
