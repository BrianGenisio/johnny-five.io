<html>
<head>
  <meta charset="utf-8">
  <title>Johnny-Five</title>
  <meta name="description" content="Johnny-Five is an Open Source IoT and robotics programming framework">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="fonts" content="css/type.css">

  <script src="../js/fontloader.js" id="fontloader"></script>

  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <link href="favicon.ico" rel="icon">

</head>
<body>

  <div class="mast">
    <nav class="nav-primary wrapper icon-j5">

      <picture class="j5-icon">
        <source type="image/svg+xml" srcset="../img/js-logo.svg">
        <img src="../img/js-logo.png">
      </picture>

      <a href="/">Getting Started</a>
      <a href="/examples.html" class="current">Examples</a>
    </nav>

    <header role="banner" class="banner">
     <h1 class="site-hed">Examples</h1>
    </header>
  </div>

  <main class="central">
    <div class="wrap-a wrap-docs">

      <h1>Sonar Scan</h1>
<p>Run with:</p>
<pre><code class="language-bash">node eg/sonar-scan.js
</code></pre>
<pre><code class="language-javascript">var five = require(&quot;johnny-five&quot;),
  board;

board = new five.Board();

board.on(&quot;ready&quot;, function() {
  var center, collision, degrees, step, facing,
    range, redirect, look, isScanning, scanner, sonar, servos;

  // Collision distance (inches)
  collision = 6;

  // Starting scanner scanning position (degrees)
  degrees = 90;

  // Servo scanning steps (degrees)
  step = 10;

  // Current facing direction
  facing = &quot;&quot;;

  // Scanning range (degrees)
  range = [0, 170];

  // Servo center point (degrees)
  center = range[1] / 2;

  // Redirection map
  redirect = {
    left: &quot;right&quot;,
    right: &quot;left&quot;
  };

  // Direction to look after releasing scanner lock (degrees)
  look = {
    forward: center,
    left: 130,
    right: 40
  };

  // Scanning state
  isScanning = true;

  // Sonar instance (distance detection)
  sonar = new five.Sonar(&quot;A2&quot;);
  // Servo instance (panning)
  scanner = new five.Servo({
    pin: 12,
    range: range
  });

  servos = {
    right: new five.Servo({
      pin: 10,
      type: &quot;continuous&quot;
    }),
    left: new five.Servo({
      pin: 11,
      type: &quot;continuous&quot;
    })
  };

  // Initialize the scanner at it's center point
  // Will be exactly half way between the range's
  // lower and upper bound
  scanner.center();

  servos.right.to(90);
  servos.left.to(90);

  // Scanner/Panning loop
  this.loop(100, function() {
    var bounds;

    bounds = {
      left: center + 10,
      right: center - 10
    };

    // During course change, scanning is paused to avoid
    // overeager redirect instructions[1]
    if (isScanning) {
      // Calculate the next step position
      if (degrees &gt;= scanner.range[1] || degrees === scanner.range[0]) {
        step *= -1;
      }

      // Update the position in degrees
      degrees += step;

      // The following three conditions will help determine
      // which way the bot should turn if a potential collision
      // may occur in the sonar &quot;change&quot; event handler[2]
      if (degrees &gt; bounds.left) {
        facing = &quot;left&quot;;
      }

      if (degrees &lt; bounds.right) {
        facing = &quot;right&quot;;
      }

      if (degrees &gt; bounds.right &amp;&amp; degrees &lt; bounds.left) {
        facing = &quot;forward&quot;;
      }

      scanner.to(degrees);
    }
  });

  // [2] Sonar &quot;change&quot; events are emitted when the value of a
  // distance reading has changed since the previous reading
  //
  sonar.on(&quot;change&quot;, function(err) {
    var turnTo;

    // Detect collision
    if (Math.abs(this.inches) &lt; collision &amp;&amp; isScanning) {
      // Scanning lock will prevent multiple collision detections
      // of the same obstacle
      isScanning = false;
      turnTo = redirect[facing] || Object.keys(redirect)[Date.now() % 2];

      // Log collision detection to REPL
      console.log(
        [Date.now(),
          &quot;Collision detected &quot; + this.inches + &quot; inches away.&quot;,
          &quot;Turning &quot; + turnTo.toUpperCase() + &quot; to avoid&quot;
        ].join(&quot;\n&quot;)
      );

      // Override the next scan position (degrees)
      // degrees = look[ turnTo ];

      // [1] Allow 1000ms to pass and release the scanning lock
      // by setting isScanning state to true.
      board.wait(1500, function() {
        console.log(&quot;Release Scanner Lock&quot;);
        isScanning = true;
      });
    }
  });
});


// Reference
//
// http://www.maxbotix.com/pictures/articles/012_Diagram_690X480.jpg

</code></pre>
<h2>License</h2>
<p>Copyright (c) 2012, 2013, 2014 Rick Waldron <a href="mailto:waldron.rick@gmail.com">waldron.rick@gmail.com</a>
Licensed under the MIT license.
Copyright (c) 2014, 2015 The Johnny-Five Contributors
Licensed under the MIT license.</p>


    </div>
  </main>

<script src="js/main.js"></script>
<script src="js/programs.json"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
